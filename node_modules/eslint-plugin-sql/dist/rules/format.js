'use strict';

Object.defineProperty(exports, "__esModule", {
  value: true
});

var _pgFormatter = require('pg-formatter');

var _astring = require('astring');

var _isSqlQuery = require('../utilities/isSqlQuery');

var _isSqlQuery2 = _interopRequireDefault(_isSqlQuery);

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

exports.default = function (context) {
  var placeholderRule = context.settings.sql && context.settings.sql.placeholderRule;

  var pluginOptions = context.options && context.options[0] || {};

  var ignoreExpressions = pluginOptions.ignoreExpressions === true;
  var ignoreInline = pluginOptions.ignoreInline !== false;
  var ignoreTagless = pluginOptions.ignoreTagless !== false;

  return {
    TemplateLiteral(node) {
      var sqlTagIsPresent = node.parent.tag && node.parent.tag.name === 'sql';

      if (ignoreTagless && !sqlTagIsPresent) {
        return;
      }

      if (ignoreExpressions && node.quasis.length !== 1) {
        return;
      }

      var magic = '"gajus-eslint-plugin-sql"';

      var literal = node.quasis.map(function (quasi) {
        return quasi.value.raw;
      }).join(magic);

      if (!sqlTagIsPresent && !(0, _isSqlQuery2.default)(literal, placeholderRule)) {
        return;
      }

      if (ignoreInline && !literal.includes('\n')) {
        return;
      }

      var formatted = (0, _pgFormatter.format)(literal, context.options[1]);

      if (formatted !== literal) {
        context.report({
          fix: function fix(fixer) {
            var final = formatted;

            var expressionCount = node.expressions.length;
            var index = 0;

            while (index <= expressionCount - 1) {
              final = final.replace(magic, '${' + (0, _astring.generate)(node.expressions[index]) + '}');

              index++;
            }

            return fixer.replaceTextRange([node.quasis[0].range[0], node.quasis[node.quasis.length - 1].range[1]], '`\n' + final + '`');
          },
          message: 'Format the query',
          node
        });
      }
    }
  };
};

module.exports = exports['default'];